# Apple-Match-for-Ashley
Creating an interesting game only for my love, Ashley. Hope her happy everyday!
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üíï AshleyÁöÑ‰∏ìÂ±ûËãπÊûúÊ∂àÊ∂à‰πê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        .hearts-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .heart {
            position: absolute;
            font-size: 1.5rem;
            animation: floatHeart 8s linear infinite;
            opacity: 0.6;
        }
        
        @keyframes floatHeart {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-50px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            z-index: 10;
        }
        
        .main-menu {
            text-align: center;
            color: white;
        }
        
        .title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: titleGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes titleGlow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(255,182,193,0.4); }
            to { text-shadow: 2px 2px 4px rgba(0,0,0,0.3), 0 0 30px rgba(255,182,193,0.8); }
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 200px;
        }
        
        .menu-btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .menu-btn:hover, .menu-btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .level-select {
            display: none;
            padding: 1rem;
            max-width: 1000px;
            width: 100%;
        }
        
        .level-header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .level-button {
            padding: 1.5rem;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .level-button.special {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            animation: specialPulse 2s ease-in-out infinite alternate;
        }
        
        .level-button.practice {
            background: linear-gradient(135deg, #55a3ff, #003d82);
            border: 2px solid #ffd700;
        }
        
        @keyframes specialPulse {
            from { box-shadow: 0 4px 15px rgba(0,0,0,0.2), 0 0 20px rgba(253,121,168,0.3); }
            to { box-shadow: 0 6px 25px rgba(0,0,0,0.3), 0 0 30px rgba(253,121,168,0.6); }
        }
        
        .level-button:hover, .level-button:active {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .love-quote {
            font-style: italic;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.9;
        }
        
        .game-screen {
            display: none;
            padding: 1rem;
            max-width: 600px;
            width: 100%;
        }
        
        .game-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: white;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 0.8rem 0.5rem;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 0.2rem;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1;
            position: relative;
        }
        
        .grid-cell {
            background: #ffffff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            touch-action: manipulation;
        }
        
        .grid-cell:hover {
            background: #f0f8ff;
        }
        
        .grid-cell.selected {
            background: #ffd700 !important;
            box-shadow: 0 0 10px rgba(255,215,0,0.6);
            transform: scale(1.05);
        }
        
        .grid-cell.special-item {
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            animation: specialGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes specialGlow {
            from { box-shadow: 0 0 10px rgba(255,215,0,0.4); }
            to { box-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 30px rgba(255,107,107,0.4); }
        }
        
        .apple-icon {
            font-size: 1.8rem;
            transition: all 0.2s ease;
        }
        
        .power-ups {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            width: 100%;
            max-width: 400px;
        }
        
        .power-up {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 0.8rem 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            touch-action: manipulation;
        }
        
        .power-up:hover, .power-up:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .power-up.active {
            background: #4CAF50;
            color: white;
            box-shadow: 0 0 20px rgba(76,175,80,0.5);
        }
        
        .power-up .icon {
            font-size: 1.2rem;
            margin-bottom: 0.2rem;
        }
        
        .power-up .name {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 0.2rem;
        }
        
        .power-up .count {
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            width: 100%;
            max-width: 400px;
            margin-top: 1rem;
        }
        
        .control-btn {
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .control-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .control-btn:hover, .control-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .pause-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .pause-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            color: white;
            max-width: 90vw;
        }
        
        .pause-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,107,107,0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            z-index: 100;
            animation: comboPop 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes comboPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        .achievement-popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 1rem 2rem;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 999;
            text-align: center;
            transition: transform 0.5s ease;
            max-width: 90vw;
        }
        
        .achievement-popup.show {
            transform: translateX(-50%) translateY(0);
        }
        
        @media (max-width: 480px) {
            .title {
                font-size: 2rem;
            }
            
            .game-header {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(2, 1fr);
            }
            
            .power-ups {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .apple-icon {
                font-size: 1.4rem;
            }
        }
        
        /* Ê∏∏ÊàèËØ¥ÊòéÂºπÁ™óÊ†∑Âºè */
        .game-guide {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .guide-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 2rem;
            border-radius: 20px;
            color: white;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .guide-section {
            margin-bottom: 1.5rem;
        }
        
        .guide-section h3 {
            margin-bottom: 0.8rem;
            color: #ffd700;
        }
        
        .guide-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .guide-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            min-width: 40px;
            text-align: center;
        }
        
        .guide-text {
            flex: 1;
        }
        
        .guide-title {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }
        
        .guide-desc {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Áà±ÂøÉËÉåÊôØ -->
    <div class="hearts-background" id="heartsBackground"></div>
    
    <!-- ‰∏ªËèúÂçï -->
    <div class="screen main-menu" id="mainMenu">
        <h1 class="title">üçéüíï AshleyÁöÑ‰∏ìÂ±ûËãπÊûúÊ∂àÊ∂à‰πê</h1>
        <p class="subtitle">‰∏∫ÊúÄÁæé‰∏ΩÁöÑ‰Ω†ÈáèË∫´ÂÆöÂà∂ ‚ú®</p>
        <div class="menu-buttons">
            <button class="menu-btn" onclick="showLevelSelect()">ÂºÄÂßãÊ∏∏Êàè üéÆ</button>
            <button class="menu-btn" onclick="showAchievements()">ÊàêÂ∞±Á≥ªÁªü üèÜ</button>
            <button class="menu-btn" onclick="showLoveMessages()">‰∏ìÂ±ûÊÉÖËØù üíï</button>
            <button class="menu-btn" onclick="showSettings()">Ê∏∏ÊàèËØ¥Êòé ‚öôÔ∏è</button>
        </div>
    </div>
    
    <!-- ÈÄâÂÖ≥ÁïåÈù¢ -->
    <div class="screen level-select" id="levelSelect">
        <div class="level-header">
            <h2 style="margin-bottom: 0.5rem;">ÈÄâÊã©ÂÖ≥Âç°</h2>
            <p>ÊØè‰∏ÄÂÖ≥ÈÉΩÊúâ‰∏ìÂ±ûÁöÑÁà±ÊÉÖËØùËØ≠ üíñ</p>
            <button class="menu-btn" onclick="backToMainMenu()" style="margin: 1rem auto; display: block; max-width: 200px;">ËøîÂõû‰∏ªËèúÂçï ‚¨ÖÔ∏è</button>
        </div>
        <div class="level-grid" id="levelGrid"></div>
    </div>
    
    <!-- Ê∏∏ÊàèÁïåÈù¢ -->
    <div class="screen game-screen" id="gameScreen">
        <!-- Ê∏∏ÊàèÁä∂ÊÄÅÊ†è -->
        <div class="game-header">
            <div class="stat-item">
                <div class="stat-label">ÂÖ≥Âç°</div>
                <div class="stat-value" id="currentLevel">1</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ÂæóÂàÜ</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ÁõÆÊ†á</div>
                <div class="stat-value" id="target">1000</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Ââ©‰ΩôÊ≠•Êï∞</div>
                <div class="stat-value" id="moves">250</div>
            </div>
        </div>
        
        <div class="game-container">
            <!-- Ê∏∏ÊàèÁΩëÊ†º -->
            <div class="game-grid" id="gameGrid"></div>
            
            <!-- ÈÅìÂÖ∑Ê†è -->
            <div class="power-ups" id="powerUps">
                <div class="power-up" data-power="bomb">
                    <div class="icon">üí•</div>
                    <div class="name">ÁÇ∏Âºπ</div>
                    <div class="count">10</div>
                </div>
                <div class="power-up" data-power="lightning">
                    <div class="icon">‚ö°</div>
                    <div class="name">Èó™Áîµ</div>
                    <div class="count">10</div>
                </div>
                <div class="power-up" data-power="rainbow">
                    <div class="icon">üåà</div>
                    <div class="name">ÂΩ©Ëôπ</div>
                    <div class="count">8</div>
                </div>
                <div class="power-up" data-power="hammer">
                    <div class="icon">üî®</div>
                    <div class="name">Èî§Â≠ê</div>
                    <div class="count">15</div>
                </div>
                <div class="power-up" data-power="shuffle">
                    <div class="icon">üîÑ</div>
                    <div class="name">Ê¥óÁâå</div>
                    <div class="count">8</div>
                </div>
                <div class="power-up" data-power="time">
                    <div class="icon">‚è∞</div>
                    <div class="name">Êó∂ÂÖâ</div>
                    <div class="count">8</div>
                </div>
            </div>
            
            <!-- ÊéßÂà∂ÊåâÈíÆ -->
            <div class="controls">
                <button class="control-btn secondary" onclick="showGameGuide()">Ê∏∏ÊàèËØ¥Êòé üìñ</button>
                <button class="control-btn secondary" onclick="showHint()">ÊèêÁ§∫ üí°</button>
                <button class="control-btn secondary" onclick="pauseGame()">ÊöÇÂÅú ‚è∏Ô∏è</button>
                <button class="control-btn secondary" onclick="restartLevel()">ÈáçÊñ∞ÂºÄÂßã üîÑ</button>
                <button class="control-btn secondary" onclick="backToLevelSelect()">ËøîÂõûÈÄâÂÖ≥ ‚¨ÖÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- ÊöÇÂÅúËèúÂçï -->
    <div class="pause-menu" id="pauseMenu">
        <div class="pause-content">
            <h3>Ê∏∏ÊàèÊöÇÂÅú</h3>
            <div class="pause-buttons">
                <button class="menu-btn" onclick="resumeGame()">ÁªßÁª≠Ê∏∏Êàè ‚ñ∂Ô∏è</button>
                <button class="menu-btn" onclick="restartLevel()">ÈáçÊñ∞ÂºÄÂßã üîÑ</button>
                <button class="menu-btn" onclick="backToLevelSelect()">ËøîÂõûÈÄâÂÖ≥ ‚¨ÖÔ∏è</button>
                <button class="menu-btn" onclick="backToMainMenu()">‰∏ªËèúÂçï üè†</button>
            </div>
        </div>
    </div>
    
    <!-- Ê∏∏ÊàèËØ¥ÊòéÂºπÁ™ó -->
    <div class="game-guide" id="gameGuide">
        <div class="guide-content">
            <h2 style="text-align: center; margin-bottom: 1.5rem; color: #ffd700;">üéÆ Ê∏∏ÊàèËØ¥Êòé</h2>
            
            <div class="guide-section">
                <h3>üéØ Ê∏∏ÊàèÁõÆÊ†á</h3>
                <p style="margin-bottom: 1rem;">‰∫§Êç¢Áõ∏ÈÇªÁöÑËãπÊûúÔºåÊ∂àÈô§3‰∏™ÊàñÊõ¥Â§öÁõ∏ÂêåÁöÑËãπÊûúÊù•Ëé∑ÂæóÂàÜÊï∞ÔºåËææÂà∞ÁõÆÊ†áÂàÜÊï∞Âç≥ÂèØËøáÂÖ≥ÔºÅ</p>
            </div>
            
            <div class="guide-section">
                <h3>üîß ÈÅìÂÖ∑ËØ¶Ëß£</h3>
                <div class="guide-item">
                    <div class="guide-icon">üí•</div>
                    <div class="guide-text">
                        <div class="guide-title">ÁÇ∏Âºπ</div>
                        <div class="guide-desc">Ê∂àÈô§‰ª•ÁÇπÂáª‰ΩçÁΩÆ‰∏∫‰∏≠ÂøÉÁöÑ3√ó3ËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâËãπÊûú</div>
                    </div>
                </div>
                <div class="guide-item">
                    <div class="guide-icon">‚ö°</div>
                    <div class="guide-text">
                        <div class="guide-title">Èó™Áîµ</div>
                        <div class="guide-desc">ÂêåÊó∂Ê∂àÈô§ÁÇπÂáª‰ΩçÁΩÆÁöÑÊï¥Ë°åÂíåÊï¥ÂàóËãπÊûú</div>
                    </div>
                </div>
                <div class="guide-item">
                    <div class="guide-icon">üåà</div>
                    <div class="guide-text">
                        <div class="guide-title">ÂΩ©Ëôπ</div>
                        <div class="guide-desc">Ê∂àÈô§‰∏éÁÇπÂáªËãπÊûúÁõ∏ÂêåÁ±ªÂûãÁöÑÊâÄÊúâËãπÊûú</div>
                    </div>
                </div>
                <div class="guide-item">
                    <div class="guide-icon">üî®</div>
                    <div class="guide-text">
                        <div class="guide-title">Èî§Â≠ê</div>
                        <div class="guide-desc">Ê∂àÈô§Âçï‰∏™ÊåáÂÆö‰ΩçÁΩÆÁöÑËãπÊûú</div>
                    </div>
                </div>
                <div class="guide-item">
                    <div class="guide-icon">üîÑ</div>
                    <div class="guide-text">
                        <div class="guide-title">Ê¥óÁâå</div>
                        <div class="guide-desc">ÈáçÊñ∞Êâì‰π±Êï¥‰∏™Ê£ãÁõòÁöÑËãπÊûúÊéíÂàó</div>
                    </div>
                </div>
                <div class="guide-item">
                    <div class="guide-icon">‚è∞</div>
                    <div class="guide-text">
                        <div class="guide-title">Êó∂ÂÖâ</div>
                        <div class="guide-desc">Â¢ûÂä†50Ê≠•È¢ùÂ§ñÁöÑÁßªÂä®Ê≠•Êï∞</div>
                    </div>
                </div>
            </div>
            
            <div class="guide-section">
                <h3>üèÜ ËøûÂáªÊäÄÂ∑ß</h3>
                <p style="margin-bottom: 1rem;">ËøûÁª≠Ê∂àÈô§‰ºö‰∫ßÁîüËøûÂáªÂ•ñÂä±ÔºÅËøûÂáªË∂äÈ´òÔºåÂàÜÊï∞Âä†ÊàêË∂äÂ§ö„ÄÇÂ∞ùËØïÂØªÊâæËøûÈîÅÂèçÂ∫îÁöÑÊú∫‰ºöÔºåÂàõÈÄ†Êõ¥È´òËøûÂáªÔºÅ</p>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="menu-btn" onclick="closeGameGuide()">Áü•ÈÅì‰∫Ü ‚úÖ</button>
            </div>
        </div>
    </div>
    
    <!-- ÊàêÂ∞±ÂºπÁ™ó -->
    <div class="achievement-popup" id="achievementPopup">
        <div id="achievementText"></div>
    </div>
    
    <!-- ÁâπÊÆäÊó•ÊúüÊïàÊûúÂÆπÂô® -->
    <div id="specialDateEffect" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999;"></div>

<script>
// ÁªßÁª≠Á¨¨‰∫åÈÉ®ÂàÜ...
// Ê∏∏ÊàèÁä∂ÊÄÅ
const gameState = {
    grid: [],
    score: 0,
    target: 1000,
    moves: 250,
    currentLevel: 1,
    selectedCell: null,
    isGameActive: false,
    isPaused: false,
    combo: 0,
    maxCombo: 0,
    totalMatches: 0,
    soundEnabled: true,
    activePowerUp: null,
    powerUps: {
        bomb: 10,       // ÁÇ∏ÂºπÂ¢ûÂä†Âà∞10‰∏™
        lightning: 10,  // Èó™ÁîµÂ¢ûÂä†Âà∞10‰∏™
        rainbow: 8,     // ÂΩ©ËôπÂ¢ûÂä†Âà∞8‰∏™
        hammer: 15,     // Èî§Â≠êÂ¢ûÂä†Âà∞15‰∏™
        shuffle: 8,     // Ê¥óÁâåÂ¢ûÂä†Âà∞8‰∏™
        time: 8         // Êó∂ÂÖâÂ¢ûÂä†Âà∞8‰∏™
    },
    // ÁªüËÆ°Êï∞ÊçÆ
    achievements: new Set(),
    totalScore: 0,
    gamesPlayed: 0,
    perfectGames: 0
};

// ËãπÊûúÁ±ªÂûãÈÖçÁΩÆ
const APPLE_TYPES = [
    { emoji: 'üçé', class: 'red-apple', type: 'red' },
    { emoji: 'üçè', class: 'green-apple', type: 'green' },
    { emoji: 'üçä', class: 'orange-apple', type: 'orange' },
    { emoji: 'üçã', class: 'yellow-apple', type: 'yellow' },
    { emoji: 'üçá', class: 'purple-apple', type: 'purple' },
    { emoji: 'üçë', class: 'cherry-apple', type: 'cherry' }
];

// ÂÖ≥Âç°ÈÖçÁΩÆÔºàÂ¢ûÂä†ÂàùÂßãÊ≠•Êï∞10ÂÄçÔºåÊèêÈ´òËøûÂáªÊ¶ÇÁéáÔºâ
const LEVELS = [
    {
        id: 1,
        target: 1000,
        moves: 300,    // ‰ªé30Â¢ûÂä†Âà∞300
        quote: "Â∞±ÂÉèÊ∂àÈô§Ëøô‰∫õËãπÊûú‰∏ÄÊ†∑ÔºåÊàëÊÉ≥Ê∂àÈô§‰Ω†ÊâÄÊúâÁöÑÁÉ¶ÊÅº üíï",
        difficulty: 'easy',
        specialApples: 0.1,
        comboBoost: 1.5    // Â¢ûÂä†ËøûÂáªÊ¶ÇÁéá
    },
    {
        id: 2,
        target: 1500,
        moves: 350,    // ‰ªé35Â¢ûÂä†Âà∞350
        quote: "ÊØè‰∏ÄÊ¨°ÂåπÈÖçÔºåÈÉΩÂÉèÊàë‰ª¨ÂøÉÁÅµÁöÑÂ•ëÂêà ‚ú®",
        difficulty: 'easy',
        specialApples: 0.15,
        comboBoost: 1.4
    },
    {
        id: 3,
        target: 2000,
        moves: 400,    // ‰ªé40Â¢ûÂä†Âà∞400
        quote: "Á∫¢ËãπÊûúÊòØÊàëÁöÑÂøÉÔºåÁªøËãπÊûúÊòØÊàë‰ª¨ÁöÑÂ∏åÊúõ üçéüíö",
        difficulty: 'normal',
        special: true,
        specialApples: 0.2,
        comboBoost: 1.6
    },
    {
        id: 4,
        target: 2500,
        moves: 450,    // ‰ªé45Â¢ûÂä†Âà∞450
        quote: "Â∞±ÁÆóÊúâÂÜçÂ§öÊåëÊàòÔºåÊàë‰πüË¶ÅÂíå‰Ω†‰∏ÄËµ∑ÈóØÂÖ≥ üí™üíï",
        difficulty: 'normal',
        specialApples: 0.15,
        comboBoost: 1.3
    },
    {
        id: 5,
        target: 3000,
        moves: 500,    // ‰ªé50Â¢ûÂä†Âà∞500
        quote: "‰∫îÂÖ≥‰∫ÜÂë¢ÔºåÂ∞±ÂÉèÊàë‰ª¨ËÆ§ËØÜÁöÑÁ¨¨‰∫î‰∏™Êúà‰∏ÄÊ†∑ÁæéÂ•Ω üå∏",
        difficulty: 'normal',
        specialApples: 0.2,
        comboBoost: 1.5
    },
    {
        id: 6,
        target: 3500,
        moves: 550,    // ‰ªé55Â¢ûÂä†Âà∞550
        quote: "ÂÖ≠ÂÖ≠Â§ßÈ°∫ÔºåÂ∏åÊúõÊàë‰ª¨ÁöÑÁà±ÊÉÖ‰πüÂÖ≠ÂÖ≠Â§ßÈ°∫ üçÄ",
        difficulty: 'hard',
        specialApples: 0.25,
        comboBoost: 1.7
    },
    {
        id: 7,
        target: 4000,
        moves: 600,    // ‰ªé60Â¢ûÂä†Âà∞600
        quote: "Á¨¨‰∏ÉÂÖ≥ÔºåÂÉè‰∏ÉËâ≤ÂΩ©Ëôπ‰∏ÄÊ†∑ÁªöÁÉÇÁöÑÊàë‰ª¨ üåà",
        difficulty: 'hard',
        special: true,
        specialApples: 0.3,
        comboBoost: 1.8
    },
    {
        id: 8,
        target: 4500,
        moves: 650,    // ‰ªé65Â¢ûÂä†Âà∞650
        quote: "ÂÖ´Ëøô‰∏™Êï∞Â≠óÂ§öÂêâÂà©ÔºåÂÉèÊàë‰ª¨ÁöÑÁà±ÊÉÖ‰∏ÄÊ†∑ÂèëÂèëÂèë üí∞üíï",
        difficulty: 'hard',
        specialApples: 0.25,
        comboBoost: 1.6
    },
    {
        id: 9,
        target: 5000,
        moves: 700,    // ‰ªé70Â¢ûÂä†Âà∞700
        quote: "‰πùÂÖ≥‰∫ÜÔºÅÈïøÈïø‰πÖ‰πÖÔºåÊàë‰ª¨Ë¶Å‰∏ÄÁõ¥Âú®‰∏ÄËµ∑ üíç",
        difficulty: 'expert',
        specialApples: 0.35,
        comboBoost: 2.0    // ÊúÄÈ´òËøûÂáªÂä†Êàê
    },
    {
        id: 10,
        target: 5500,
        moves: 750,    // ‰ªé75Â¢ûÂä†Âà∞750
        quote: "ÂçÅÂÖ®ÂçÅÁæéÁöÑÊàë‰ª¨ÔºåÂçÅÂÖ®ÂçÅÁæéÁöÑÁà±ÊÉÖ üíØüíï",
        difficulty: 'expert',
        special: true,
        specialApples: 0.4,
        comboBoost: 1.9
    },
    {
        id: 11,
        target: 6000,
        moves: 800,    // ‰ªé80Â¢ûÂä†Âà∞800
        quote: "11Ëøô‰∏™Êï∞Â≠óÔºåÂÉè‰∏§‰∏™‰∫∫Á¥ßÁ¥ßÁõ∏‰æù üë´üíï",
        difficulty: 'expert',
        specialApples: 0.3,
        comboBoost: 1.7
    },
    {
        id: 12,
        target: 6500,
        moves: 850,    // ‰ªé85Â¢ûÂä†Âà∞850
        quote: "ÊúÄÂêé‰∏ÄÂÖ≥‰∫ÜÔºÅÂ∞±ÂÉèÊàë‰ª¨Ë¶Å‰∏ÄËµ∑Ëµ∞Âà∞ÊúÄÂêé‰∏ÄÊ†∑ üåÖüíï",
        difficulty: 'master',
        special: true,
        specialApples: 0.5,
        comboBoost: 2.2    // ÊúÄÁªàÂÖ≥Âç°ÊúÄÈ´òÂä†Êàê
    }
];

// ÊàêÂ∞±Á≥ªÁªü
const ACHIEVEMENTS = [
    {
        id: 'first_match',
        name: 'ÂàùÊ¨°ÈÇÇÈÄÖ',
        desc: 'ÂÆåÊàêÁ¨¨‰∏ÄÊ¨°ËãπÊûúÊ∂àÈô§',
        icon: 'üåü'
    },
    {
        id: 'combo_master',
        name: 'ËøûÂáªËææ‰∫∫',
        desc: 'ËææÊàê10ËøûÂáª',
        icon: 'üî•'
    },
    {
        id: 'score_hunter',
        name: 'ÂàÜÊï∞ÁåéÊâã', 
        desc: 'ÂçïÂ±ÄÂæóÂàÜË∂ÖËøá5000ÂàÜ',
        icon: 'üéØ'
    },
    {
        id: 'perfect_level',
        name: 'ÂÆåÁæéÈÄöÂÖ≥',
        desc: 'Ââ©‰ΩôÊ≠•Êï∞Ë∂ÖËøá100Ê≠•ÂÆåÊàêÂÖ≥Âç°',
        icon: 'üëë'
    },
    {
        id: 'power_master',
        name: 'ÈÅìÂÖ∑Â§ßÂ∏à',
        desc: '‰ΩøÁî®ËøáÊâÄÊúâÁ±ªÂûãÁöÑÈÅìÂÖ∑',
        icon: '‚ö°'
    },
    {
        id: 'love_master',
        name: 'Ashley‰∏ìÂ±û',
        desc: 'ÂÆåÊàêÊâÄÊúâÁâπÊÆäÂÖ≥Âç°',
        icon: 'üíï'
    },
    {
        id: 'ashley_special',
        name: 'ÁúüÁà±Â•áËøπ',
        desc: 'AshleyÁöÑ‰∏ìÂ±ûÊàêÂ∞±',
        icon: '‚ú®'
    }
];

// Ê∏∏ÊàèÂàùÂßãÂåñ
function initializeGame() {
    loadGameData();
    createHeartsBackground();
    createLevelButtons();
    setupEventListeners();
    checkSpecialDate();
}

// ÂàõÂª∫Áà±ÂøÉËÉåÊôØ
function createHeartsBackground() {
    const container = document.getElementById('heartsBackground');
    
    for (let i = 0; i < 15; i++) {
        const heart = document.createElement('div');
        heart.className = 'heart';
        heart.innerHTML = ['üíï', 'üíñ', 'üíó', 'üíù', 'üíò'][Math.floor(Math.random() * 5)];
        heart.style.left = Math.random() * 100 + '%';
        heart.style.animationDelay = Math.random() * 8 + 's';
        heart.style.animationDuration = (Math.random() * 4 + 6) + 's';
        container.appendChild(heart);
    }
}

// ÂàõÂª∫ÂÖ≥Âç°ÊåâÈíÆ
function createLevelButtons() {
    const levelGrid = document.getElementById('levelGrid');
    
    // ÁªÉ‰π†Ê®°ÂºèÊåâÈíÆ
    const practiceButton = document.createElement('button');
    practiceButton.className = 'level-button practice';
    practiceButton.innerHTML = `
        <h3>üéØ ÁªÉ‰π†Ê®°Âºè</h3>
        <p>Êó†ÈôêÊ≠•Êï∞ÔºåÈöèÊÑèÁªÉ‰π†</p>
        <div class="love-quote">Âú®ËøôÈáåÂ∞ΩÊÉÖ‰∫´ÂèóÊ∏∏ÊàèÁöÑÂø´‰πêÂêß üòä</div>
    `;
    practiceButton.onclick = () => startLevel(0);
    levelGrid.appendChild(practiceButton);
    
    // Ê≠£Â∏∏ÂÖ≥Âç°ÊåâÈíÆ
    LEVELS.forEach(level => {
        const button = document.createElement('button');
        button.className = `level-button ${level.special ? 'special' : ''}`;
        button.innerHTML = `
            <h3>${level.special ? 'üíñ' : 'üçé'} Á¨¨ ${level.id} ÂÖ≥</h3>
            <p>ÁõÆÊ†á: ${level.target} ÂàÜ | Ê≠•Êï∞: ${level.moves}</p>
            <div class="love-quote">${level.quote}</div>
        `;
        button.onclick = () => startLevel(level.id);
        levelGrid.appendChild(button);
    });
}

// Ê£ÄÊü•ÁâπÊÆäÊó•Êúü
function checkSpecialDate() {
    const today = new Date();
    const month = today.getMonth() + 1;
    const date = today.getDate();
    
    // AshleyÁöÑÁîüÊó• 3Êúà25Êó•
    if (month === 3 && date === 25) {
        createBirthdayEffect();
        setTimeout(() => {
            showMessage("üéÇ ÁîüÊó•Âø´‰πêÔºåÊàëÁöÑÂÆùË¥ùAshleyÔºÅËøôÊòØ‰∏ìÂ±û‰∫é‰Ω†ÁöÑÁâπÊÆäÊó•Â≠êÔºÅüíï");
        }, 2000);
    }
    
    // ÊÉÖ‰∫∫ËäÇ 2Êúà14Êó•
    if (month === 2 && date === 14) {
        createValentineEffect();
        setTimeout(() => {
            showMessage("üíù ÊÉÖ‰∫∫ËäÇÂø´‰πêÔºÅÊÑøÊàë‰ª¨ÁöÑÁà±ÊÉÖÁîúÁîúËúúËúúÔºÅ");
        }, 2000);
    }
}

// ÂºÄÂßãÂÖ≥Âç°
function startLevel(levelId) {
    gameState.currentLevel = levelId;
    gameState.isGameActive = true;
    gameState.isPaused = false;
    gameState.combo = 0;
    gameState.selectedCell = null;
    gameState.activePowerUp = null;
    
    if (levelId === 0) {
        // ÁªÉ‰π†Ê®°Âºè
        gameState.score = 0;
        gameState.target = Infinity;
        gameState.moves = Infinity;
        // ÁªÉ‰π†Ê®°ÂºèÈÅìÂÖ∑Êõ¥Â§ö
        gameState.powerUps = {
            bomb: 20,
            lightning: 20, 
            rainbow: 15,
            hammer: 25,
            shuffle: 15,
            time: 15
        };
    } else {
        // Ê≠£Â∏∏ÂÖ≥Âç°
        const level = LEVELS.find(l => l.id === levelId);
        gameState.score = 0;
        gameState.target = level.target;
        gameState.moves = level.moves;
        
        // Ê†πÊçÆÂÖ≥Âç°Ë∞ÉÊï¥ÈÅìÂÖ∑Êï∞Èáè
        const baseMultiplier = Math.min(1 + (levelId * 0.1), 2.5); // ÊúÄÈ´ò2.5ÂÄç
        gameState.powerUps = {
            bomb: Math.floor(10 * baseMultiplier),
            lightning: Math.floor(10 * baseMultiplier),
            rainbow: Math.floor(8 * baseMultiplier),
            hammer: Math.floor(15 * baseMultiplier),
            shuffle: Math.floor(8 * baseMultiplier),
            time: Math.floor(8 * baseMultiplier)
        };
    }
    
    initializeGrid();
    showGameScreen();
    updateUI();
    
    // ÊòæÁ§∫ÂÖ≥Âç°ÂºÄÂßãÊ∂àÊÅØ
    if (levelId > 0) {
        const level = LEVELS.find(l => l.id === levelId);
        setTimeout(() => {
            showMessage(`üíñ ${level.quote}`);
        }, 500);
    } else {
        setTimeout(() => {
            showMessage("üéØ ÁªÉ‰π†Ê®°ÂºèÂºÄÂßãÔºÅÂ∞ΩÊÉÖ‰∫´ÂèóÊ∏∏Êàè‰πêË∂£ÂêßÔºÅ");
        }, 500);
    }
}

// ÂàùÂßãÂåñÊ∏∏ÊàèÁΩëÊ†º
function initializeGrid() {
    gameState.grid = [];
    const gameGrid = document.getElementById('gameGrid');
    gameGrid.innerHTML = '';
    
    // ÂàõÂª∫8x8ÁΩëÊ†º
    for (let row = 0; row < 8; row++) {
        gameState.grid[row] = [];
        for (let col = 0; col < 8; col++) {
            gameState.grid[row][col] = createRandomApple();
            
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.row = row;
            cell.dataset.col = col;
            
            updateCellDisplay(row, col);
            setupCellInteraction(cell, row, col);
            
            gameGrid.appendChild(cell);
        }
    }
    
    // Á°Æ‰øùÊ≤°ÊúâÂàùÂßãÂåπÈÖçÔºåÂπ∂Â¢ûÂä†ËøûÂáªÊ¶ÇÁéá
    removeInitialMatches();
    enhanceComboOpportunities();
}

// Â¢ûÂº∫ËøûÂáªÊú∫‰ºöÔºàÊñ∞Â¢ûÂáΩÊï∞Ôºâ
function enhanceComboOpportunities() {
    const currentLevel = LEVELS.find(l => l.id === gameState.currentLevel);
    if (!currentLevel) return;
    
    // Ê†πÊçÆÂÖ≥Âç°ÁöÑcomboBoostÂÄºÂàõÂª∫Êõ¥Â§öËøûÂáªÊú∫‰ºö
    const comboBoost = currentLevel.comboBoost || 1.0;
    const enhancedCells = Math.floor(8 * comboBoost); // Â¢ûÂº∫ÁöÑÊ†ºÂ≠êÊï∞Èáè
    
    for (let i = 0; i < enhancedCells; i++) {
        const row = Math.floor(Math.random() * 8);
        const col = Math.floor(Math.random() * 8);
        
        // Âú®ÈöèÊú∫‰ΩçÁΩÆÊîæÁΩÆÂÆπÊòì‰∫ßÁîüËøûÂáªÁöÑËãπÊûúÁªÑÂêà
        if (row < 6 && col < 6) {
            const appleType = APPLE_TYPES[Math.floor(Math.random() * APPLE_TYPES.length)];
            gameState.grid[row][col] = { ...appleType };
            gameState.grid[row + 1][col] = { ...appleType };
            
            // 35%Ê¶ÇÁéáÂàõÂª∫Êõ¥ÈïøÁöÑËøûÂáªÈìæ
            if (Math.random() < 0.35) {
                gameState.grid[row][col + 1] = { ...appleType };
            }
            
            updateCellDisplay(row, col);
            updateCellDisplay(row + 1, col);
            if (gameState.grid[row][col + 1]?.type === appleType.type) {
                updateCellDisplay(row, col + 1);
            }
        }
    }
    
    // Ê∑ªÂä†‰∏Ä‰∫õÁâπÊÆäËãπÊûúÊù•Â¢ûÂä†ËøûÂáªÊ¶ÇÁéá
    if (Math.random() < currentLevel.specialApples) {
        addRandomSpecialItems();
    }
}

// ÂàõÂª∫ÈöèÊú∫ËãπÊûú
function createRandomApple() {
    return { ...APPLE_TYPES[Math.floor(Math.random() * APPLE_TYPES.length)] };
}

// ÁßªÈô§ÂàùÂßãÂåπÈÖç
function removeInitialMatches() {
    let hasMatches = true;
    let attempts = 0;
    const maxAttempts = 50;
    
    while (hasMatches && attempts < maxAttempts) {
        hasMatches = false;
        
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if (hasMatchAtPosition(row, col)) {
                    gameState.grid[row][col] = createRandomApple();
                    hasMatches = true;
                }
            }
        }
        attempts++;
    }
    
    // Êõ¥Êñ∞ÊâÄÊúâÂçïÂÖÉÊ†ºÊòæÁ§∫
    for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
            updateCellDisplay(row, col);
        }
    }
}

// Ê£ÄÊü•ÊåáÂÆö‰ΩçÁΩÆÊòØÂê¶ÊúâÂåπÈÖç
function hasMatchAtPosition(row, col) {
    const currentType = gameState.grid[row][col]?.type;
    if (!currentType) return false;
    
    // Ê£ÄÊü•Ê∞¥Âπ≥ÂåπÈÖç
    let horizontalCount = 1;
    // ÂêëÂ∑¶Ê£ÄÊü•
    for (let c = col - 1; c >= 0 && gameState.grid[row][c]?.type === currentType; c--) {
        horizontalCount++;
    }
    // ÂêëÂè≥Ê£ÄÊü•
    for (let c = col + 1; c < 8 && gameState.grid[row][c]?.type === currentType; c++) {
        horizontalCount++;
    }
    
    // Ê£ÄÊü•ÂûÇÁõ¥ÂåπÈÖç
    let verticalCount = 1;
    // Âêë‰∏äÊ£ÄÊü•
    for (let r = row - 1; r >= 0 && gameState.grid[r][col]?.type === currentType; r--) {
        verticalCount++;
    }
    // Âêë‰∏ãÊ£ÄÊü•
    for (let r = row + 1; r < 8 && gameState.grid[r][col]?.type === currentType; r++) {
        verticalCount++;
    }
    
    return horizontalCount >= 3 || verticalCount >= 3;
}

// Êõ¥Êñ∞ÂçïÂÖÉÊ†ºÊòæÁ§∫
function updateCellDisplay(row, col) {
    const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    const apple = gameState.grid[row][col];
    
    if (cell && apple) {
        cell.innerHTML = `<span class="apple-icon">${apple.emoji}</span>`;
        cell.className = `grid-cell ${apple.class || ''}`;
    }
}

// Ê∏∏ÊàèËØ¥ÊòéÁõ∏ÂÖ≥ÂáΩÊï∞
function showGameGuide() {
    document.getElementById('gameGuide').style.display = 'flex';
}

function closeGameGuide() {
    document.getElementById('gameGuide').style.display = 'none';
}

// Èü≥ÊïàÊí≠Êîæ
gameState.playSound = function(soundType) {
    if (!this.soundEnabled) return;
    
    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑÈü≥ÊïàÊí≠Êîæ‰ª£Á†Å
    // Áî±‰∫éÊòØÊºîÁ§∫ÁâàÊú¨ÔºåÊöÇÊó∂Áî®console.log‰ª£Êõø
    // console.log(`Playing sound: ${soundType}`);
};
// ËÆæÁΩÆÂçïÂÖÉÊ†º‰∫§‰∫í
function setupCellInteraction(cell, row, col) {
    let startX, startY;
    
    // Ëß¶Êë∏ÂºÄÂßã
    cell.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        
        handleCellClick(row, col);
    }, { passive: false });
    
    // Ëß¶Êë∏ÁßªÂä® - ÂÆûÁé∞ÊãñÊãΩ‰∫§Êç¢
    cell.addEventListener('touchmove', function(e) {
        e.preventDefault();
        if (!startX || !startY) return;
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - startX;
        const deltaY = touch.clientY - startY;
        const minSwipeDistance = 30;
        
        if (Math.abs(deltaX) > minSwipeDistance || Math.abs(deltaY) > minSwipeDistance) {
            let targetRow = row;
            let targetCol = col;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Ê∞¥Âπ≥ÊªëÂä®
                targetCol = deltaX > 0 ? col + 1 : col - 1;
            } else {
                // ÂûÇÁõ¥ÊªëÂä®
                targetRow = deltaY > 0 ? row + 1 : row - 1;
            }
            
            if (targetRow >= 0 && targetRow < 8 && targetCol >= 0 && targetCol < 8) {
                attemptSwap(row, col, targetRow, targetCol);
            }
            
            startX = null;
            startY = null;
        }
    }, { passive: false });
    
    // ÁÇπÂáª‰∫ã‰ª∂Ôºà‰Ωú‰∏∫Â§áÁî®Ôºâ
    cell.addEventListener('click', function(e) {
        e.preventDefault();
        handleCellClick(row, col);
    });
}

// Â§ÑÁêÜÂçïÂÖÉÊ†ºÁÇπÂáª
function handleCellClick(row, col) {
    if (!gameState.isGameActive || gameState.isPaused) return;
    
    // Â¶ÇÊûúÊúâÊøÄÊ¥ªÁöÑÈÅìÂÖ∑Ôºå‰ΩøÁî®ÈÅìÂÖ∑
    if (gameState.activePowerUp) {
        usePowerUp(gameState.activePowerUp, row, col);
        return;
    }
    
    const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    
    if (gameState.selectedCell) {
        const [selectedRow, selectedCol] = gameState.selectedCell;
        
        if (selectedRow === row && selectedCol === col) {
            // ÂèñÊ∂àÈÄâÊã©
            deselectCell();
            return;
        }
        
        // Â∞ùËØï‰∫§Êç¢
        if (isAdjacent(selectedRow, selectedCol, row, col)) {
            attemptSwap(selectedRow, selectedCol, row, col);
        } else {
            // ÈÄâÊã©Êñ∞ÂçïÂÖÉÊ†º
            deselectCell();
            selectCell(row, col);
        }
    } else {
        // ÈÄâÊã©ÂçïÂÖÉÊ†º
        selectCell(row, col);
    }
}

// ÈÄâÊã©ÂçïÂÖÉÊ†º
function selectCell(row, col) {
    gameState.selectedCell = [row, col];
    const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    if (cell) {
        cell.classList.add('selected');
    }
}

// ÂèñÊ∂àÈÄâÊã©
function deselectCell() {
    if (gameState.selectedCell) {
        const [row, col] = gameState.selectedCell;
        const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (cell) {
            cell.classList.remove('selected');
        }
        gameState.selectedCell = null;
    }
}

// Ê£ÄÊü•‰∏§‰∏™‰ΩçÁΩÆÊòØÂê¶Áõ∏ÈÇª
function isAdjacent(row1, col1, row2, col2) {
    const rowDiff = Math.abs(row1 - row2);
    const colDiff = Math.abs(col1 - col2);
    return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
}

// Â∞ùËØï‰∫§Êç¢
function attemptSwap(row1, col1, row2, col2) {
    // ‰∏¥Êó∂‰∫§Êç¢
    const temp = gameState.grid[row1][col1];
    gameState.grid[row1][col1] = gameState.grid[row2][col2];
    gameState.grid[row2][col2] = temp;
    
    // Ê£ÄÊü•ÊòØÂê¶‰∫ßÁîüÂåπÈÖç
    const matches = findMatches();
    
    if (matches.length > 0) {
        // ÊúâÊïà‰∫§Êç¢
        deselectCell();
        updateCellDisplay(row1, col1);
        updateCellDisplay(row2, col2);
        
        // Ê∑ªÂä†‰∫§Êç¢Âä®Áîª
        animateSwap(row1, col1, row2, col2);
        
        // Ê∂àËÄóÊ≠•Êï∞ÔºàÁªÉ‰π†Ê®°Âºè‰∏çÊ∂àËÄóÔºâ
        if (gameState.currentLevel > 0) {
            gameState.moves--;
        }
        
        // Â§ÑÁêÜÂåπÈÖç
        setTimeout(() => {
            processMatches();
        }, 300);
        
        gameState.playSound('swap');
    } else {
        // Êó†Êïà‰∫§Êç¢ÔºåÊÅ¢Â§çÂéüÁä∂
        gameState.grid[row2][col2] = gameState.grid[row1][col1];
        gameState.grid[row1][col1] = temp;
        
        // ÊòæÁ§∫Êó†ÊïàÊèêÁ§∫
        showInvalidSwapAnimation(row1, col1, row2, col2);
        deselectCell();
    }
    
    updateUI();
}

// ‰∫§Êç¢Âä®Áîª
function animateSwap(row1, col1, row2, col2) {
    const cell1 = document.querySelector(`[data-row="${row1}"][data-col="${col1}"]`);
    const cell2 = document.querySelector(`[data-row="${row2}"][data-col="${col2}"]`);
    
    if (cell1 && cell2) {
        cell1.style.transform = 'scale(1.1)';
        cell2.style.transform = 'scale(1.1)';
        
        setTimeout(() => {
            cell1.style.transform = '';
            cell2.style.transform = '';
        }, 200);
    }
}

// Êó†Êïà‰∫§Êç¢Âä®Áîª
function showInvalidSwapAnimation(row1, col1, row2, col2) {
    const cell1 = document.querySelector(`[data-row="${row1}"][data-col="${col1}"]`);
    const cell2 = document.querySelector(`[data-row="${row2}"][data-col="${col2}"]`);
    
    if (cell1 && cell2) {
        cell1.style.animation = 'shake 0.5s ease-in-out';
        cell2.style.animation = 'shake 0.5s ease-in-out';
        
        setTimeout(() => {
            cell1.style.animation = '';
            cell2.style.animation = '';
        }, 500);
    }
    
    // Ê∑ªÂä†ÊëáÊëÜÂä®ÁîªCSSÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâÁöÑËØùÔºâ
    if (!document.querySelector('#shakeAnimation')) {
        const style = document.createElement('style');
        style.id = 'shakeAnimation';
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
    }
}

// ÂØªÊâæÂåπÈÖç
function findMatches() {
    const matches = new Set();
    
    // Ê£ÄÊü•Ê∞¥Âπ≥ÂåπÈÖç
    for (let row = 0; row < 8; row++) {
        let count = 1;
        let currentType = gameState.grid[row][0]?.type;
        
        for (let col = 1; col < 8; col++) {
            if (gameState.grid[row][col]?.type === currentType && currentType) {
                count++;
            } else {
                if (count >= 3) {
                    for (let i = col - count; i < col; i++) {
                        matches.add(`${row}-${i}`);
                    }
                }
                count = 1;
                currentType = gameState.grid[row][col]?.type;
            }
        }
        
        // Ê£ÄÊü•Ë°åÊú´Â∞æ
        if (count >= 3) {
            for (let i = 8 - count; i < 8; i++) {
                matches.add(`${row}-${i}`);
            }
        }
    }
    
    // Ê£ÄÊü•ÂûÇÁõ¥ÂåπÈÖç
    for (let col = 0; col < 8; col++) {
        let count = 1;
        let currentType = gameState.grid[0][col]?.type;
        
        for (let row = 1; row < 8; row++) {
            if (gameState.grid[row][col]?.type === currentType && currentType) {
                count++;
            } else {
                if (count >= 3) {
                    for (let i = row - count; i < row; i++) {
                        matches.add(`${i}-${col}`);
                    }
                }
                count = 1;
                currentType = gameState.grid[row][col]?.type;
            }
        }
        
        // Ê£ÄÊü•ÂàóÊú´Â∞æ
        if (count >= 3) {
            for (let i = 8 - count; i < 8; i++) {
                matches.add(`${i}-${col}`);
            }
        }
    }
    
    return Array.from(matches).map(pos => {
        const [row, col] = pos.split('-').map(Number);
        return { row, col };
    });
}

// Â§ÑÁêÜÂåπÈÖçÔºàÂ¢ûÂº∫ËøûÂáªÈÄªËæëÔºâ
async function processMatches() {
    let totalMatches = 0;
    let comboCount = 0;
    const currentLevel = LEVELS.find(l => l.id === gameState.currentLevel);
    const comboBoost = currentLevel?.comboBoost || 1.0;
    
    while (true) {
        const matches = findMatches();
        if (matches.length === 0) break;
        
        comboCount++;
        totalMatches += matches.length;
        
        // ËøûÂáªÂä†ÂàÜËÆ°ÁÆóÔºàÂ¢ûÂº∫ÁâàÔºâ
        const baseScore = matches.length * 100;
        const comboMultiplier = Math.min(1 + (comboCount - 1) * 0.5 * comboBoost, 5.0); // ÊúÄÈ´ò5ÂÄç
        const finalScore = Math.floor(baseScore * comboMultiplier);
        
        gameState.score += finalScore;
        gameState.combo = comboCount;
        gameState.totalMatches += matches.length;
        
        // Êõ¥Êñ∞ÊúÄÂ§ßËøûÂáªËÆ∞ÂΩï
        if (comboCount > gameState.maxCombo) {
            gameState.maxCombo = comboCount;
        }
        
        // ÊòæÁ§∫ËøûÂáªÊïàÊûú
        if (comboCount > 1) {
            showComboEffect(comboCount, finalScore);
        }
        
        // Êí≠ÊîæÈü≥Êïà
        if (comboCount === 1) {
            gameState.playSound('match');
        } else {
            gameState.playSound('combo');
        }
        
        // ÁßªÈô§ÂåπÈÖçÁöÑËãπÊûúÔºàÂ∏¶Âä®ÁîªÔºâ
        await removeMatchedApples(matches);
        
        // Ê∑ªÂä†ÁâπÊÆäÈÅìÂÖ∑ÁîüÊàêÊ¶ÇÁéáÔºàËøûÂáªÊó∂Ôºâ
        if (comboCount >= 3 && Math.random() < 0.3 * comboBoost) {
            await addRandomSpecialItems();
        }
        
        // ‰∏ãËêΩ
        await dropApples();
        
        // Â°´ÂÖÖÊñ∞ËãπÊûú
        await fillEmptySpaces();
        
        // Â¢ûÂä†È¢ùÂ§ñËøûÂáªÊú∫‰ºöÔºàÂü∫‰∫écomboBoostÔºâ
        if (comboCount >= 2 && Math.random() < 0.2 * comboBoost) {
            await createRandomMatches();
        }
        
        // Áü≠ÊöÇÂª∂Ëøü‰ª•ÊòæÁ§∫Âä®Áîª
        await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    // ËøûÂáªÁªìÊùüÔºåÈáçÁΩÆËøûÂáªËÆ°Êï∞Âô®
    gameState.combo = 0;
    
    updateUI();
    checkGameStatus();
    checkAchievements();
    
    // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÂèØËÉΩÁöÑÁßªÂä®
    if (gameState.isGameActive && !gameState.isPaused) {
        const possibleMoves = findPossibleMoves();
        if (possibleMoves.length === 0) {
            setTimeout(() => {
                showMessage("Ê≤°ÊúâÂèØË°åÁöÑÁßªÂä®‰∫ÜÔºÅ");
                // Ëá™Âä®Ê¥óÁâåÊàñÊèêÁ§∫‰ΩøÁî®Ê¥óÁâåÈÅìÂÖ∑
                if (gameState.powerUps.shuffle > 0) {
                    setTimeout(() => {
                        showMessage("üí° ËØïËØï‰ΩøÁî®Ê¥óÁâåÈÅìÂÖ∑ÔºÅ");
                    }, 2000);
                }
            }, 1000);
        }
    }
}

// ÂàõÂª∫ÈöèÊú∫ÂåπÈÖçÊú∫‰ºöÔºàÊñ∞Â¢ûÂáΩÊï∞Ôºâ
async function createRandomMatches() {
    const emptyPositions = [];
    
    // ÊâæÂà∞ÂèØ‰ª•Â¢ûÂä†ÂåπÈÖçÊú∫‰ºöÁöÑ‰ΩçÁΩÆ
    for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
            if (col < 6) { // Ê∞¥Âπ≥Êú∫‰ºö
                const type1 = gameState.grid[row][col]?.type;
                const type2 = gameState.grid[row][col + 2]?.type;
                if (type1 === type2 && type1) {
                    // Âú®‰∏≠Èó¥ÊîæÁΩÆÁõ∏ÂêåÁ±ªÂûãÁöÑËãπÊûú
                    gameState.grid[row][col + 1] = { ...APPLE_TYPES.find(a => a.type === type1) };
                    updateCellDisplay(row, col + 1);
                    return;
                }
            }
            
            if (row < 6) { // ÂûÇÁõ¥Êú∫‰ºö
                const type1 = gameState.grid[row][col]?.type;
                const type2 = gameState.grid[row + 2][col]?.type;
                if (type1 === type2 && type1) {
                    // Âú®‰∏≠Èó¥ÊîæÁΩÆÁõ∏ÂêåÁ±ªÂûãÁöÑËãπÊûú
                    gameState.grid[row + 1][col] = { ...APPLE_TYPES.find(a => a.type === type1) };
                    updateCellDisplay(row + 1, col);
                    return;
                }
            }
        }
    }
}

// ÊòæÁ§∫ËøûÂáªÊïàÊûú
function showComboEffect(combo, score) {
    const comboDiv = document.createElement('div');
    comboDiv.className = 'combo-display';
    
    let comboText = '';
    if (combo >= 10) {
        comboText = `üî• AMAZING ${combo}ËøûÂáª! +${score} üî•`;
    } else if (combo >= 7) {
        comboText = `‚ö° SUPER ${combo}ËøûÂáª! +${score} ‚ö°`;
    } else if (combo >= 5) {
        comboText = `‚ú® GREAT ${combo}ËøûÂáª! +${score} ‚ú®`;
    } else if (combo >= 3) {
        comboText = `üí´ GOOD ${combo}ËøûÂáª! +${score} üí´`;
    } else {
        comboText = `üåü ${combo}ËøûÂáª! +${score} üåü`;
    }
    
    comboDiv.textContent = comboText;
    
    const gameGrid = document.getElementById('gameGrid');
    gameGrid.appendChild(comboDiv);
    
    setTimeout(() => {
        comboDiv.remove();
    }, 1000);
}

// ÁßªÈô§ÂåπÈÖçÁöÑËãπÊûú
async function removeMatchedApples(matches) {
    // Ê∑ªÂä†Ê∂àÈô§Âä®Áîª
    matches.forEach(match => {
        const cell = document.querySelector(`[data-row="${match.row}"][data-col="${match.col}"]`);
        if (cell) {
            cell.style.animation = 'fadeOut 0.3s ease-out forwards';
        }
    });
    
    // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // ÁßªÈô§ËãπÊûú
    matches.forEach(match => {
        gameState.grid[match.row][match.col] = null;
        updateCellDisplay(match.row, match.col);
    });
    
    // Ê∑ªÂä†Ê∂àÈô§Âä®ÁîªÁöÑCSS
    if (!document.querySelector('#fadeOutAnimation')) {
        const style = document.createElement('style');
        style.id = 'fadeOutAnimation';
        style.textContent = `
            @keyframes fadeOut {
                0% { transform: scale(1); opacity: 1; }
                100% { transform: scale(0.8); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
}
// ÈÅìÂÖ∑Áõ∏ÂÖ≥ÂäüËÉΩ
function setupPowerUpButtons() {
    document.querySelectorAll('.power-up').forEach(button => {
        button.addEventListener('click', function() {
            const powerType = this.dataset.power;
            selectPowerUp(powerType);
        });
    });
}

// ÈÄâÊã©ÈÅìÂÖ∑
function selectPowerUp(powerType) {
    if (!gameState.isGameActive || gameState.isPaused) return;
    
    if (gameState.powerUps[powerType] <= 0) {
        showMessage('‚ùå ÈÅìÂÖ∑Êï∞Èáè‰∏çË∂≥ÔºÅ');
        return;
    }
    
    // ÂèñÊ∂à‰πãÂâçÁöÑÈÅìÂÖ∑ÈÄâÊã©
    document.querySelectorAll('.power-up').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (gameState.activePowerUp === powerType) {
        // ÂèñÊ∂àÈÄâÊã©
        gameState.activePowerUp = null;
        showMessage('ÂèñÊ∂àÈÅìÂÖ∑ÈÄâÊã©');
    } else {
        // ÈÄâÊã©Êñ∞ÈÅìÂÖ∑
        gameState.activePowerUp = powerType;
        const button = document.querySelector(`[data-power="${powerType}"]`);
        if (button) {
            button.classList.add('active');
        }
        
        const powerNames = {
            bomb: 'üí• ÁÇ∏Âºπ',
            lightning: '‚ö° Èó™Áîµ', 
            rainbow: 'üåà ÂΩ©Ëôπ',
            hammer: 'üî® Èî§Â≠ê',
            shuffle: 'üîÑ Ê¥óÁâå',
            time: '‚è∞ Êó∂ÂÖâ'
        };
        
        showMessage(`Â∑≤ÈÄâÊã©ÈÅìÂÖ∑Ôºö${powerNames[powerType]}`);
        
        // Ê¥óÁâåÂíåÊó∂ÂÖâÈÅìÂÖ∑Áõ¥Êé•‰ΩøÁî®
        if (powerType === 'shuffle') {
            usePowerUp('shuffle', 0, 0);
        } else if (powerType === 'time') {
            usePowerUp('time', 0, 0);
        }
    }
}

// ‰ΩøÁî®ÈÅìÂÖ∑
function usePowerUp(powerType, row, col) {
    if (gameState.powerUps[powerType] <= 0) {
        showMessage('‚ùå ÈÅìÂÖ∑Êï∞Èáè‰∏çË∂≥ÔºÅ');
        return;
    }
    
    // Ê∂àËÄóÈÅìÂÖ∑
    gameState.powerUps[powerType]--;
    gameState.activePowerUp = null;
    
    // ÂèñÊ∂àÊâÄÊúâÈÅìÂÖ∑ÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
    document.querySelectorAll('.power-up').forEach(btn => {
        btn.classList.remove('active');
    });
    
    switch (powerType) {
        case 'bomb':
            useBomb(row, col);
            break;
        case 'lightning':
            useLightning(row, col);
            break;
        case 'rainbow':
            useRainbow(row, col);
            break;
        case 'hammer':
            useHammer(row, col);
            break;
        case 'shuffle':
            useShuffle();
            break;
        case 'time':
            useTime();
            break;
    }
    
    updatePowerUpUI();
    gameState.playSound('powerUp');
    checkAchievements();
}

// ÁÇ∏ÂºπÈÅìÂÖ∑ - Ê∂àÈô§3x3ËåÉÂõ¥
function useBomb(centerRow, centerCol) {
    const affectedCells = [];
    
    for (let row = Math.max(0, centerRow - 1); row <= Math.min(7, centerRow + 1); row++) {
        for (let col = Math.max(0, centerCol - 1); col <= Math.min(7, centerCol + 1); col++) {
            if (gameState.grid[row][col]) {
                affectedCells.push({ row, col });
            }
        }
    }
    
    // ÁàÜÁÇ∏Âä®Áîª
    showExplosionEffect(centerRow, centerCol);
    
    setTimeout(() => {
        const score = affectedCells.length * 150; // ÁÇ∏ÂºπÂàÜÊï∞Êõ¥È´ò
        gameState.score += score;
        
        affectedCells.forEach(({row, col}) => {
            gameState.grid[row][col] = null;
            updateCellDisplay(row, col);
        });
        
        showMessage(`üí• ÁÇ∏ÂºπÁàÜÁÇ∏ÔºÅËé∑Âæó ${score} ÂàÜÔºÅ`);
        
        setTimeout(() => {
            processAfterPowerUp();
        }, 500);
    }, 600);
}

// Èó™ÁîµÈÅìÂÖ∑ - Ê∂àÈô§Êï¥Ë°åÊï¥Âàó
function useLightning(row, col) {
    const affectedCells = [];
    
    // Êî∂ÈõÜÊï¥Ë°å
    for (let c = 0; c < 8; c++) {
        if (gameState.grid[row][c]) {
            affectedCells.push({ row, col: c });
        }
    }
    
    // Êî∂ÈõÜÊï¥Âàó
    for (let r = 0; r < 8; r++) {
        if (gameState.grid[r][col] && !affectedCells.some(cell => cell.row === r && cell.col === col)) {
            affectedCells.push({ row: r, col });
        }
    }
    
    // Èó™ÁîµÂä®Áîª
    showLightningEffect(row, col);
    
    setTimeout(() => {
        const score = affectedCells.length * 120;
        gameState.score += score;
        
        affectedCells.forEach(({row, col}) => {
            gameState.grid[row][col] = null;
            updateCellDisplay(row, col);
        });
        
        showMessage(`‚ö° Èó™Áîµ‰∏ÄÂáªÔºÅËé∑Âæó ${score} ÂàÜÔºÅ`);
        
        setTimeout(() => {
            processAfterPowerUp();
        }, 500);
    }, 800);
}

// ÂΩ©ËôπÈÅìÂÖ∑ - Ê∂àÈô§ÊâÄÊúâÁõ∏ÂêåÁ±ªÂûã
function useRainbow(row, col) {
    const targetType = gameState.grid[row][col]?.type;
    if (!targetType) {
        showMessage('‚ùå ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑËãπÊûúÔºÅ');
        gameState.powerUps.rainbow++; // ÈÄÄËøòÈÅìÂÖ∑
        updatePowerUpUI();
        return;
    }
    
    const affectedCells = [];
    for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
            if (gameState.grid[r][c]?.type === targetType) {
                affectedCells.push({ row: r, col: c });
            }
        }
    }
    
    // ÂΩ©ËôπÂä®Áîª
    showRainbowEffect();
    
    setTimeout(() => {
        const score = affectedCells.length * 200; // ÂΩ©ËôπÂàÜÊï∞ÊúÄÈ´ò
        gameState.score += score;
        
        affectedCells.forEach(({row, col}) => {
            gameState.grid[row][col] = null;
            updateCellDisplay(row, col);
        });
        
        showMessage(`üåà ÂΩ©ËôπÊ∂àÈô§ÔºÅËé∑Âæó ${score} ÂàÜÔºÅ`);
        
        setTimeout(() => {
            processAfterPowerUp();
        }, 500);
    }, 1000);
}

// Èî§Â≠êÈÅìÂÖ∑ - Ê∂àÈô§Âçï‰∏™ËãπÊûú
function useHammer(row, col) {
    if (!gameState.grid[row][col]) {
        showMessage('‚ùå ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑËãπÊûúÔºÅ');
        gameState.powerUps.hammer++; // ÈÄÄËøòÈÅìÂÖ∑
        updatePowerUpUI();
        return;
    }
    
    // Èî§ÂáªÂä®Áîª
    showHammerEffect(row, col);
    
    setTimeout(() => {
        gameState.score += 100;
        gameState.grid[row][col] = null;
        updateCellDisplay(row, col);
        
        showMessage('üî® Á≤æÂáÜÊâìÂáªÔºÅËé∑Âæó 100 ÂàÜÔºÅ');
        
        setTimeout(() => {
            processAfterPowerUp();
        }, 300);
    }, 400);
}

// Ê¥óÁâåÈÅìÂÖ∑ - ÈáçÊñ∞ÊéíÂàó
function useShuffle() {
    // Ê¥óÁâåÂä®Áîª
    showShuffleEffect();
    
    setTimeout(() => {
        const allApples = [];
        
        // Êî∂ÈõÜÊâÄÊúâËãπÊûú
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if (gameState.grid[row][col]) {
                    allApples.push(gameState.grid[row][col]);
                }
            }
        }
        
        // Ê¥óÁâå
        for (let i = allApples.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allApples[i], allApples[j]] = [allApples[j], allApples[i]];
        }
        
        // ÈáçÊñ∞ÊîæÁΩÆ
        let index = 0;
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if (index < allApples.length) {
                    gameState.grid[row][col] = allApples[index++];
                    updateCellDisplay(row, col);
                }
            }
        }
        
        // Á°Æ‰øùÊ¥óÁâåÂêéÊ≤°ÊúâÂàùÂßãÂåπÈÖç
        removeInitialMatches();
        // Â¢ûÂä†ËøûÂáªÊú∫‰ºö
        enhanceComboOpportunities();
        
        showMessage('üîÑ Ê£ãÁõòÊ¥óÁâåÂÆåÊàêÔºÅ');
        
        setTimeout(() => {
            // Ê£ÄÊü•Ê¥óÁâåÂêéÊòØÂê¶‰∫ßÁîü‰∫ÜÂåπÈÖç
            const matches = findMatches();
            if (matches.length > 0) {
                processMatches();
            }
        }, 500);
    }, 1000);
}

// Êó∂ÂÖâÈÅìÂÖ∑ - Â¢ûÂä†Ê≠•Êï∞Ôºà‰øÆÊîπ‰∏∫Â¢ûÂä†50Ê≠•Ôºâ
function useTime() {
    if (gameState.currentLevel === 0) {
        showMessage('‚è∞ ÁªÉ‰π†Ê®°ÂºèÂ∑≤ÁªèÊòØÊó†ÈôêÊ≠•Êï∞‰∫ÜÔºÅ');
        gameState.powerUps.time++; // ÈÄÄËøòÈÅìÂÖ∑
        updatePowerUpUI();
        return;
    }
    
    const addedMoves = 50; // ‰ªé5Ê≠•Â¢ûÂä†Âà∞50Ê≠•
    gameState.moves += addedMoves;
    
    // Êó∂ÂÖâÂä®Áîª
    showTimeEffect();
    
    showMessage(`‚è∞ Êó∂ÂÖâÂÄíÊµÅÔºÅÂ¢ûÂä† ${addedMoves} Ê≠•ÔºÅ`);
    updateUI();
}

// ÈÅìÂÖ∑‰ΩøÁî®ÂêéÁöÑÂ§ÑÁêÜ
async function processAfterPowerUp() {
    await dropApples();
    await fillEmptySpaces();
    
    // Ê£ÄÊü•ÊòØÂê¶‰∫ßÁîüÊñ∞ÁöÑÂåπÈÖç
    const matches = findMatches();
    if (matches.length > 0) {
        setTimeout(() => {
            processMatches();
        }, 300);
    } else {
        updateUI();
    }
}

// ËãπÊûú‰∏ãËêΩ
async function dropApples() {
    let needsDrop = true;
    
    while (needsDrop) {
        needsDrop = false;
        
        for (let col = 0; col < 8; col++) {
            for (let row = 7; row >= 0; row--) {
                if (!gameState.grid[row][col]) {
                    // ÊâæÂà∞‰∏äÈù¢ÁöÑËãπÊûú
                    for (let r = row - 1; r >= 0; r--) {
                        if (gameState.grid[r][col]) {
                            gameState.grid[row][col] = gameState.grid[r][col];
                            gameState.grid[r][col] = null;
                            needsDrop = true;
                            break;
                        }
                    }
                }
            }
        }
        
        // Êõ¥Êñ∞ÊòæÁ§∫
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                updateCellDisplay(row, col);
            }
        }
        
        if (needsDrop) {
            await new Promise(resolve => setTimeout(resolve, 150));
        }
    }
}

// Â°´ÂÖÖÁ©∫Ê†º
async function fillEmptySpaces() {
    for (let col = 0; col < 8; col++) {
        for (let row = 0; row < 8; row++) {
            if (!gameState.grid[row][col]) {
                gameState.grid[row][col] = createRandomApple();
                updateCellDisplay(row, col);
                
                // Ê∑ªÂä†‰∏ãËêΩÂä®Áîª
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (cell) {
                    cell.style.animation = 'dropIn 0.3s ease-out';
                    setTimeout(() => {
                        cell.style.animation = '';
                    }, 300);
                }
                
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
    }
    
    // Ê∑ªÂä†‰∏ãËêΩÂä®ÁîªCSS
    if (!document.querySelector('#dropInAnimation')) {
        const style = document.createElement('style');
        style.id = 'dropInAnimation';
        style.textContent = `
            @keyframes dropIn {
                0% { transform: translateY(-20px); opacity: 0; }
                100% { transform: translateY(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
}

// Ê∑ªÂä†ÈöèÊú∫ÁâπÊÆäÈÅìÂÖ∑ÔºàÂ¢ûÂº∫ËøûÂáªÊ¶ÇÁéáÔºâ
async function addRandomSpecialItems() {
    const specialCount = Math.floor(Math.random() * 3) + 1; // 1-3‰∏™ÁâπÊÆäÈÅìÂÖ∑
    
    for (let i = 0; i < specialCount; i++) {
        const emptyPositions = [];
        
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if (gameState.grid[row][col]) {
                    emptyPositions.push({ row, col });
                }
            }
        }
        
        if (emptyPositions.length > 0) {
            const randomPos = emptyPositions[Math.floor(Math.random() * emptyPositions.length)];
            const cell = document.querySelector(`[data-row="${randomPos.row}"][data-col="${randomPos.col}"]`);
            
            if (cell) {
                cell.classList.add('special-item');
                
                // ÁâπÊÆäÊïàÊûúÔºöËøô‰∏™‰ΩçÁΩÆÁöÑËãπÊûúÊõ¥ÂÆπÊòì‰∫ßÁîüËøûÂáª
                const currentApple = gameState.grid[randomPos.row][randomPos.col];
                currentApple.special = true;
                currentApple.comboBonus = 2.0; // ËøûÂáªÂä†Êàê
            }
        }
    }
}

// ÁâπÊïàÂä®ÁîªÂáΩÊï∞
function showExplosionEffect(centerRow, centerCol) {
    const cell = document.querySelector(`[data-row="${centerRow}"][data-col="${centerCol}"]`);
    if (!cell) return;
    
    const explosion = document.createElement('div');
    explosion.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        z-index: 100;
        animation: explode 0.6s ease-out forwards;
        pointer-events: none;
    `;
    explosion.textContent = 'üí•';
    
    cell.style.position = 'relative';
    cell.appendChild(explosion);
    
    // Ê∑ªÂä†ÁàÜÁÇ∏Âä®ÁîªCSS
    if (!document.querySelector('#explodeAnimation')) {
        const style = document.createElement('style');
        style.id = 'explodeAnimation';
        style.textContent = `
            @keyframes explode {
                0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
                50% { transform: translate(-50%, -50%) scale(2); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        explosion.remove();
    }, 600);
}

function showLightningEffect(row, col) {
    const gameGrid = document.getElementById('gameGrid');
    
    // ÂàõÂª∫Èó™ÁîµÊïàÊûú
    const lightning = document.createElement('div');
    lightning.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 45%, #fff3cd 50%, transparent 55%);
        z-index: 99;
        animation: lightning 0.8s ease-out forwards;
        pointer-events: none;
    `;
    
    gameGrid.style.position = 'relative';
    gameGrid.appendChild(lightning);
    
    // Ê∑ªÂä†Èó™ÁîµÂä®ÁîªCSS
    if (!document.querySelector('#lightningAnimation')) {
        const style = document.createElement('style');
        style.id = 'lightningAnimation';
        style.textContent = `
            @keyframes lightning {
                0%, 100% { opacity: 0; }
                10%, 20%, 30% { opacity: 1; }
                15%, 25% { opacity: 0.5; }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        lightning.remove();
    }, 800);
}

function showRainbowEffect() {
    const gameGrid = document.getElementById('gameGrid');
    
    const rainbow = document.createElement('div');
    rainbow.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, 
            #ff0000 0%, #ff8000 14%, #ffff00 28%, 
            #80ff00 42%, #00ff00 57%, #00ff80 71%, 
            #00ffff 85%, #0080ff 100%);
        opacity: 0.3;
        z-index: 99;
        animation: rainbow 1s ease-in-out forwards;
        pointer-events: none;
    `;
    
    gameGrid.appendChild(rainbow);
    
    // Ê∑ªÂä†ÂΩ©ËôπÂä®ÁîªCSS
    if (!document.querySelector('#rainbowAnimation')) {
        const style = document.createElement('style');
        style.id = 'rainbowAnimation';
        style.textContent = `
            @keyframes rainbow {
                0% { opacity: 0; transform: scale(0); }
                50% { opacity: 0.6; transform: scale(1.1); }
                100% { opacity: 0; transform: scale(1.2); }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        rainbow.remove();
    }, 1000);
}

function showHammerEffect(row, col) {
    const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    if (!cell) return;
    
    const hammer = document.createElement('div');
    hammer.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        z-index: 100;
        animation: hammer 0.4s ease-out forwards;
        pointer-events: none;
    `;
    hammer.textContent = 'üî®';
    
    cell.style.position = 'relative';
    cell.appendChild(hammer);
    
    // Ê∑ªÂä†Èî§ÂáªÂä®ÁîªCSS
    if (!document.querySelector('#hammerAnimation')) {
        const style = document.createElement('style');
        style.id = 'hammerAnimation';
        style.textContent = `
            @keyframes hammer {
                0% { transform: translate(-50%, -100%) rotate(-45deg); }
                50% { transform: translate(-50%, -50%) rotate(0deg); }
                100% { transform: translate(-50%, -50%) rotate(0deg) scale(1.5); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        hammer.remove();
    }, 400);
}

function showShuffleEffect() {
    const gameGrid = document.getElementById('gameGrid');
    
    gameGrid.style.animation = 'shuffle 1s ease-in-out';
    
    // Ê∑ªÂä†Ê¥óÁâåÂä®ÁîªCSS
    if (!document.querySelector('#shuffleAnimation')) {
        const style = document.createElement('style');
        style.id = 'shuffleAnimation';
        style.textContent = `
            @keyframes shuffle {
                0%, 100% { transform: rotate(0deg); }
                25% { transform: rotate(2deg); }
                75% { transform: rotate(-2deg); }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        gameGrid.style.animation = '';
    }, 1000);
}

function showTimeEffect() {
    const gameGrid = document.getElementById('gameGrid');
    
    const timeEffect = document.createElement('div');
    timeEffect.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4rem;
        color: #ffd700;
        z-index: 100;
        animation: timeReverse 2s ease-out forwards;
        pointer-events: none;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    `;
    timeEffect.textContent = '‚è∞';
    
    gameGrid.style.position = 'relative';
    gameGrid.appendChild(timeEffect);
    
    // Ê∑ªÂä†Êó∂ÂÖâÂä®ÁîªCSS
    if (!document.querySelector('#timeAnimation')) {
        const style = document.createElement('style');
        style.id = 'timeAnimation';
        style.textContent = `
            @keyframes timeReverse {
                0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 1; }
                50% { transform: translate(-50%, -50%) scale(1.5) rotate(180deg); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(2) rotate(360deg); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        timeEffect.remove();
    }, 2000);
}

// Êõ¥Êñ∞ÈÅìÂÖ∑UI
function updatePowerUpUI() {
    Object.keys(gameState.powerUps).forEach(powerType => {
        const button = document.querySelector(`[data-power="${powerType}"]`);
        if (button) {
            const countElement = button.querySelector('.count');
            if (countElement) {
                countElement.textContent = gameState.powerUps[powerType];
                
                // ÈÅìÂÖ∑‰∏çË∂≥Êó∂ÁöÑËßÜËßâÊèêÁ§∫
                if (gameState.powerUps[powerType] <= 0) {
                    button.style.opacity = '0.5';
                    countElement.style.backgroundColor = '#999';
                } else {
                    button.style.opacity = '1';
                    countElement.style.backgroundColor = '#ff6b6b';
                }
            }
        }
    });
}

// ÂàùÂßãÂåñÈÅìÂÖ∑Á≥ªÁªü
function initializePowerUps() {
    setupPowerUpButtons();
    updatePowerUpUI();
}
// ‰∏ã‰∏ÄÂÖ≥
function nextLevel() {
    if (gameState.currentLevel < LEVELS.length) {
        startLevel(gameState.currentLevel + 1);
    } else {
        backToLevelSelect();
        showMessage('üéâ ÊÅ≠ÂñúÂÆåÊàêÊâÄÊúâÂÖ≥Âç°ÔºÅ');
    }
}

// Ê£ÄÊü•Ê∏∏ÊàèÁä∂ÊÄÅ
function checkGameStatus() {
    if (gameState.currentLevel === 0) return; // ÁªÉ‰π†Ê®°Âºè‰∏çÊ£ÄÊü•Áä∂ÊÄÅ
    
    // Ê£ÄÊü•ÊòØÂê¶ËææÊàêÁõÆÊ†á
    if (gameState.score >= gameState.target) {
        gameState.isGameActive = false;
        gameState.gamesPlayed++;
        gameState.totalScore += gameState.score;
        
        // Ê£ÄÊü•ÂÆåÁæéÈÄöÂÖ≥
        if (gameState.moves >= 100) {
            gameState.perfectGames++;
        }
        
        showLevelCompleteDialog();
    } else if (gameState.moves <= 0) {
        // Ê≠•Êï∞Áî®ÂÆå
        gameState.isGameActive = false;
        showGameOverDialog();
    }
}

// ÊòæÁ§∫ËøáÂÖ≥ÂØπËØùÊ°Ü
function showLevelCompleteDialog() {
    const level = LEVELS.find(l => l.id === gameState.currentLevel);
    let message = `üéâ Á¨¨${gameState.currentLevel}ÂÖ≥ÂÆåÊàêÔºÅ\n\n`;
    message += `ÊúÄÁªàÂæóÂàÜ: ${gameState.score}\n`;
    message += `Ââ©‰ΩôÊ≠•Êï∞: ${gameState.moves}\n`;
    
    if (gameState.moves >= 100) {
        message += `\nüëë ÂÆåÁæéÈÄöÂÖ≥Â•ñÂä±ÔºÅ`;
    }
    
    if (gameState.maxCombo >= 5) {
        message += `\nüî• ÊúÄÈ´òËøûÂáª: ${gameState.maxCombo}`;
    }
    
    message += `\n\nüíï ${level?.quote || ''}`;
    
    setTimeout(() => {
        if (confirm(message + '\n\nÁªßÁª≠‰∏ã‰∏ÄÂÖ≥Ôºü')) {
            nextLevel();
        } else {
            backToLevelSelect();
        }
    }, 1000);
}

// ÊòæÁ§∫Ê∏∏ÊàèÁªìÊùüÂØπËØùÊ°Ü
function showGameOverDialog() {
    let message = `üòî Ê∏∏ÊàèÁªìÊùü\n\n`;
    message += `ÂΩìÂâçÂæóÂàÜ: ${gameState.score}\n`;
    message += `ÁõÆÊ†áÂàÜÊï∞: ${gameState.target}\n`;
    message += `Â∑ÆË∑ù: ${gameState.target - gameState.score}\n\n`;
    message += `‰∏çË¶ÅÊ∞îÈ¶ÅÔºåÂÜçÊù•‰∏ÄÊ¨°ÂêßÔºÅüí™`;
    
    setTimeout(() => {
        if (confirm(message + '\n\nÈáçÊñ∞ÂºÄÂßãËøô‰∏ÄÂÖ≥Ôºü')) {
            restartLevel();
        } else {
            backToLevelSelect();
        }
    }, 1000);
}

// ÊàêÂ∞±Á≥ªÁªü
function checkAchievements() {
    const newAchievements = [];
    
    // Ê£ÄÊü•ÂêÑÁßçÊàêÂ∞±Êù°‰ª∂
    if (gameState.totalMatches >= 1 && !gameState.achievements.has('first_match')) {
        newAchievements.push('first_match');
    }
    
    if (gameState.maxCombo >= 10 && !gameState.achievements.has('combo_master')) {
        newAchievements.push('combo_master');
    }
    
    if (gameState.score >= 5000 && !gameState.achievements.has('score_hunter')) {
        newAchievements.push('score_hunter');
    }
    
    if (gameState.moves >= 100 && gameState.score >= gameState.target && !gameState.achievements.has('perfect_level')) {
        newAchievements.push('perfect_level');
    }
    
    // Ê£ÄÊü•ÊòØÂê¶‰ΩøÁî®ËøáÊâÄÊúâÈÅìÂÖ∑
    const usedAllPowerUps = Object.entries(gameState.powerUps).every(([key, count]) => {
        const initialCounts = {
            bomb: 10, lightning: 10, rainbow: 8, hammer: 15, shuffle: 8, time: 8
        };
        return count < initialCounts[key];
    });
    if (usedAllPowerUps && !gameState.achievements.has('power_master')) {
        newAchievements.push('power_master');
    }
    
    // ÁâπÊÆäÊàêÂ∞± - Ashley‰∏ìÂ±û
    const completedSpecialLevels = LEVELS.filter(l => l.special).every(level => 
        gameState.currentLevel >= level.id
    );
    if (completedSpecialLevels && !gameState.achievements.has('love_master')) {
        newAchievements.push('love_master');
    }
    
    // ÊòæÁ§∫Êñ∞Ëé∑ÂæóÁöÑÊàêÂ∞±
    newAchievements.forEach((achievementId, index) => {
        gameState.achievements.add(achievementId);
        const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
        if (achievement) {
            setTimeout(() => {
                showAchievement(achievement);
            }, index * 2000 + Math.random() * 1000);
        }
    });
    
    if (newAchievements.length > 0) {
        saveGameData();
    }
}

// ÊòæÁ§∫ÊàêÂ∞±ÂºπÁ™ó
function showAchievement(achievement) {
    const popup = document.getElementById('achievementPopup');
    const text = document.getElementById('achievementText');
    
    text.innerHTML = `
        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${achievement.icon}</div>
        <div style="font-weight: bold; margin-bottom: 0.2rem;">${achievement.name}</div>
        <div style="font-size: 0.9rem;">${achievement.desc}</div>
    `;
    
    popup.classList.add('show');
    gameState.playSound('achievement');
    
    setTimeout(() => {
        popup.classList.remove('show');
    }, 3000);
}

// ÊòæÁ§∫ÊàêÂ∞±È°µÈù¢
function showAchievements() {
    let html = `
        <div class="pause-content" style="max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem; color: #ffd700;">üèÜ ÊàêÂ∞±Á≥ªÁªü</h2>
            <div style="text-align: left;">
    `;
    
    ACHIEVEMENTS.forEach(achievement => {
        const unlocked = gameState.achievements.has(achievement.id);
        html += `
            <div style="display: flex; align-items: center; padding: 1rem; margin-bottom: 0.8rem; 
                 background: ${unlocked ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255,255,255,0.1)'}; 
                 border-radius: 10px; border-left: 4px solid ${unlocked ? '#4CAF50' : '#666'};">
                <div style="font-size: 2rem; margin-right: 1rem; filter: ${unlocked ? 'none' : 'grayscale(1)'};">
                    ${achievement.icon}
                </div>
                <div>
                    <div style="font-weight: bold; margin-bottom: 0.3rem; color: ${unlocked ? '#4CAF50' : '#999'};">
                        ${achievement.name} ${unlocked ? '‚úÖ' : 'üîí'}
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">${achievement.desc}</div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 10px;">
                <h3 style="margin-bottom: 0.8rem;">üéÆ Ê∏∏ÊàèÁªüËÆ°</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: center;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;">${gameState.gamesPlayed}</div>
                        <div style="font-size: 0.8rem;">Ê∏∏ÊàèÂú∫Ê¨°</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2196F3;">${gameState.totalScore.toLocaleString()}</div>
                        <div style="font-size: 0.8rem;">Á¥ØËÆ°ÂæóÂàÜ</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #FF9800;">${gameState.maxCombo}</div>
                        <div style="font-size: 0.8rem;">ÊúÄÈ´òËøûÂáª</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #9C27B0;">${gameState.perfectGames}</div>
                        <div style="font-size: 0.8rem;">ÂÆåÁæéÈÄöÂÖ≥</div>
                    </div>
                </div>
            </div>
            <button class="menu-btn" onclick="closePauseMenu(); showScreen('mainMenu');" style="margin-top: 1.5rem;">
                ËøîÂõû‰∏ªËèúÂçï üè†
            </button>
        </div>
    `;
    
    document.getElementById('pauseMenu').innerHTML = html;
    document.getElementById('pauseMenu').style.display = 'flex';
}

// ÊòæÁ§∫‰∏ìÂ±ûÊÉÖËØùÈ°µÈù¢
function showLoveMessages() {
    const loveMessages = [
        "‰∫≤Áà±ÁöÑAshleyÔºå‰Ω†Â∞±ÂÉèËøôÊ∏∏Êàè‰∏≠ÁöÑÂΩ©ËôπÈÅìÂÖ∑ÔºåËÉΩÊ∂àÈô§ÊàëÂøÉ‰∏≠ÊâÄÊúâÁöÑÁÉ¶ÊÅº üåàüíï",
        "ÊØè‰∏ÄÊ¨°ËãπÊûúÁöÑÂåπÈÖçÔºåÈÉΩÂÉèÊàë‰ª¨ÂøÉÁÅµÁöÑÂ•ëÂêàÔºåÈÇ£‰πàÂÆåÁæéÔºåÈÇ£‰πàÁîúËúú üçéüíñ",
        "Â∞±ÂÉèÊ∏∏Êàè‰∏≠ÁöÑËøûÂáª‰∏ÄÊ†∑ÔºåÊàëÂØπ‰Ω†ÁöÑÁà±‰πüÊòØËøûÁªµ‰∏çÊñ≠ÔºåÊ∞∏‰∏çÂÅúÊ≠á üî•üíù",
        "‰Ω†ÊòØÊàëÁöÑÈôêÂÆöÁâàÈÅìÂÖ∑ÔºåÁã¨‰∏ÄÊó†‰∫åÔºåÁèçË¥µÊó†ÊØî ‚ú®üëë",
        "ÊÑøÊàë‰ª¨ÁöÑÁà±ÊÉÖÂÉèËøôÊ∏∏Êàè‰∏ÄÊ†∑ÔºåÂÖÖÊª°ÊÉäÂñúÔºåÂÖÖÊª°Âø´‰πê üéÆüíï",
        "ÊØèÂΩìÁúãÂà∞‰Ω†ÁöÑÁ¨ëÂÆπÔºåÂ∞±ÂÉèËé∑Âæó‰∫ÜÊó†ÈôêÁöÑÈÅìÂÖ∑Ôºå‰ªÄ‰πàÂõ∞ÈöæÈÉΩËÉΩÂÖãÊúç üí™‚ù§Ô∏è",
        "‰Ω†ÊòØÊàëÁîüÂëΩ‰∏≠ÊúÄÁâπÂà´ÁöÑËãπÊûúÔºåÁîúËúú„ÄÅÁèçË¥µ„ÄÅ‰∏çÂèØÊõø‰ª£ üçéüë∏",
        "Ë∑ü‰Ω†Âú®‰∏ÄËµ∑ÁöÑÊØè‰∏ÄÂ§©ÔºåÈÉΩÂÉèÈÄöÂÖ≥‰∏ÄÊ†∑ÂÖÖÊª°ÊàêÂ∞±ÊÑü üèÜüíï",
        "‰Ω†Â∞±ÊòØÊàëÁöÑ‰∏ìÂ±ûÊàêÂ∞±ÔºåÊúÄÁèçË¥µÁöÑÈÇ£‰∏Ä‰∏™ üåüüíñ",
        "ÊàëÊÑøÊÑè‰∏∫‰Ω†Ê∂àÈô§ÊâÄÊúâÁöÑÈöúÁ¢çÔºåÂ∞±ÂÉèËøôÊ∏∏Êàè‰∏≠ÁöÑÈÅìÂÖ∑‰∏ÄÊ†∑ üî®üíù"
    ];
    
    let html = `
        <div class="pause-content" style="max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-bottom: 1.5rem; color: #ffd700;">üíï ‰∏ìÂ±ûÊÉÖËØù</h2>
            <div style="text-align: left;">
    `;
    
    loveMessages.forEach((message, index) => {
        html += `
            <div style="padding: 1.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, rgba(255,182,193,0.3), rgba(255,160,122,0.3)); 
                 border-radius: 15px; border-left: 4px solid #ff6b6b;">
                <div style="font-size: 0.9rem; margin-bottom: 0.5rem; color: #666;">ÊÉÖËØù ${index + 1}</div>
                <div style="font-size: 1rem; line-height: 1.5; color: #333;">${message}</div>
            </div>
        `;
    });
    
    html += `
            </div>
            <div style="text-align: center; margin-top: 2rem; padding: 1.5rem; background: rgba(255,255,255,0.1); border-radius: 15px;">
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üíñ</div>
                <div style="font-style: italic; color: #ffd700;">
                    "Ëøô‰∫õÈÉΩÊòØ‰∏∫‰Ω†‰∏ìÈó®ÂÜôÁöÑÂ∞èÊÉÖËØù<br>
                    Â∏åÊúõÊØè‰∏ÄÂè•ÈÉΩËÉΩÊ∏©Êöñ‰Ω†ÁöÑÂøÉ ‚òÄÔ∏è"
                </div>
            </div>
            <button class="menu-btn" onclick="closePauseMenu(); showScreen('mainMenu');" style="margin-top: 1.5rem;">
                ËøîÂõû‰∏ªËèúÂçï üè†
            </button>
        </div>
    `;
    
    document.getElementById('pauseMenu').innerHTML = html;
    document.getElementById('pauseMenu').style.display = 'flex';
}

// ÊòæÁ§∫ËÆæÁΩÆÈ°µÈù¢
function showSettings() {
    let html = `
        <div class="pause-content">
            <h2 style="margin-bottom: 1.5rem; color: #ffd700;">‚öôÔ∏è Ê∏∏ÊàèËÆæÁΩÆ</h2>
            
            <div style="text-align: left; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; 
                     padding: 1rem; margin-bottom: 1rem; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <span>üîä Èü≥Êïà</span>
                    <button onclick="toggleSound()" class="menu-btn" style="padding: 0.5rem 1rem; margin: 0;">
                        ${gameState.soundEnabled ? 'ÂºÄÂêØ ‚úÖ' : 'ÂÖ≥Èó≠ ‚ùå'}
                    </button>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; 
                     padding: 1rem; margin-bottom: 1rem; background: rgba(255,255,255,0.1); border-radius: 10px;">
                    <span>üìä Ê∏ÖÈô§Êï∞ÊçÆ</span>
                    <button onclick="clearGameData()" class="menu-btn" style="padding: 0.5rem 1rem; margin: 0; background: #ff6b6b;">
                        Ê∏ÖÈô§ üóëÔ∏è
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 10px;">
                <h3 style="margin-bottom: 1rem;">‚ù§Ô∏è ÂÖ≥‰∫éÊ∏∏Êàè</h3>
                <p style="font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem;">
                    ËøôÊòØ‰∏ìÈó®‰∏∫AshleyÂÆöÂà∂ÁöÑËãπÊûúÊ∂àÊ∂à‰πêÊ∏∏ÊàèÔºåÊØè‰∏Ä‰∏™ÁªÜËäÇÈÉΩÂÖÖÊª°‰∫ÜÁà±ÊÑè„ÄÇ
                    Â∏åÊúõ‰Ω†ËÉΩÂú®Ê∏∏Êàè‰∏≠ÊÑüÂèóÂà∞Êª°Êª°ÁöÑÁà±ÂíåÂø´‰πêÔºÅ
                </p>
                <div style="text-align: center; font-size: 0.8rem; color: #ffd700;">
                    üíï Version 2.0 - Enhanced Edition üíï
                </div>
            </div>
            
            <button class="menu-btn" onclick="closePauseMenu(); showScreen('mainMenu');">
                ËøîÂõû‰∏ªËèúÂçï üè†
            </button>
        </div>
    `;
    
    document.getElementById('pauseMenu').innerHTML = html;
    document.getElementById('pauseMenu').style.display = 'flex';
}

// Èü≥ÊïàÂºÄÂÖ≥
function toggleSound() {
    gameState.soundEnabled = !gameState.soundEnabled;
    saveGameData();
    showSettings(); // Âà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢
    
    showMessage(gameState.soundEnabled ? 'üîä Èü≥ÊïàÂ∑≤ÂºÄÂêØ' : 'üîá Èü≥ÊïàÂ∑≤ÂÖ≥Èó≠');
}

// Ê∏ÖÈô§Ê∏∏ÊàèÊï∞ÊçÆ
function clearGameData() {
    if (confirm('‚ö†Ô∏è Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊ∏∏ÊàèÊï∞ÊçÆÂêóÔºü\nËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÊàêÂ∞±ÂíåÁªüËÆ°Êï∞ÊçÆÔºÅ')) {
        localStorage.removeItem('ashleyAppleGameData');
        
        // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
        gameState.achievements.clear();
        gameState.totalScore = 0;
        gameState.gamesPlayed = 0;
        gameState.perfectGames = 0;
        gameState.maxCombo = 0;
        
        showMessage('üóëÔ∏è Ê∏∏ÊàèÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§');
        showSettings(); // Âà∑Êñ∞ËÆæÁΩÆÈ°µÈù¢
    }
}

// ÁïåÈù¢ÊéßÂà∂ÂáΩÊï∞
function showScreen(screenName) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.style.display = 'none';
    });
    document.getElementById(screenName).style.display = 'flex';
}

function showGameScreen() {
    showScreen('gameScreen');
}

function showLevelSelect() {
    showScreen('levelSelect');
}

function backToMainMenu() {
    gameState.isGameActive = false;
    gameState.isPaused = false;
    closePauseMenu();
    showScreen('mainMenu');
}

function backToLevelSelect() {
    gameState.isGameActive = false;
    gameState.isPaused = false;
    closePauseMenu();
    showScreen('levelSelect');
}

// Ê∏∏ÊàèÊéßÂà∂ÂáΩÊï∞
function pauseGame() {
    if (!gameState.isGameActive) return;
    
    gameState.isPaused = true;
    showPauseMenu();
}

function resumeGame() {
    gameState.isPaused = false;
    closePauseMenu();
}

function showPauseMenu() {
    let html = `
        <div class="pause-content">
            <h3>‚è∏Ô∏è Ê∏∏ÊàèÊöÇÂÅú</h3>
            <div class="pause-buttons">
                <button class="menu-btn" onclick="resumeGame()">ÁªßÁª≠Ê∏∏Êàè ‚ñ∂Ô∏è</button>
                <button class="menu-btn" onclick="restartLevel()">ÈáçÊñ∞ÂºÄÂßã üîÑ</button>
                <button class="menu-btn" onclick="backToLevelSelect()">ËøîÂõûÈÄâÂÖ≥ ‚¨ÖÔ∏è</button>
                <button class="menu-btn" onclick="backToMainMenu()">‰∏ªËèúÂçï üè†</button>
            </div>
        </div>
    `;
    
    document.getElementById('pauseMenu').innerHTML = html;
    document.getElementById('pauseMenu').style.display = 'flex';
}

function closePauseMenu() {
    document.getElementById('pauseMenu').style.display = 'none';
}

function restartLevel() {
    closePauseMenu();
    startLevel(gameState.currentLevel);
}

// ÊèêÁ§∫Á≥ªÁªü
function showHint() {
    if (!gameState.isGameActive || gameState.isPaused) return;
    
    const possibleMoves = findPossibleMoves();
    if (possibleMoves.length === 0) {
        showMessage('üí° Ê≤°ÊúâÂèØË°åÁöÑÁßªÂä®ÔºåËØïËØï‰ΩøÁî®ÈÅìÂÖ∑ÂêßÔºÅ');
        return;
    }
    
    // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂèØËÉΩÁöÑÁßªÂä®Âπ∂È´ò‰∫ÆÊòæÁ§∫
    const randomMove = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
    highlightHint(randomMove.from.row, randomMove.from.col, randomMove.to.row, randomMove.to.col);
    
    showMessage('üí° ËØïËØïËøôÈáåÔºÅ');
}

function highlightHint(fromRow, fromCol, toRow, toCol) {
    const fromCell = document.querySelector(`[data-row="${fromRow}"][data-col="${fromCol}"]`);
    const toCell = document.querySelector(`[data-row="${toRow}"][data-col="${toCol}"]`);
    
    if (fromCell && toCell) {
        fromCell.style.animation = 'hint 2s ease-in-out';
        toCell.style.animation = 'hint 2s ease-in-out';
        
        setTimeout(() => {
            fromCell.style.animation = '';
            toCell.style.animation = '';
        }, 2000);
    }
    
    // Ê∑ªÂä†ÊèêÁ§∫Âä®ÁîªCSS
    if (!document.querySelector('#hintAnimation')) {
        const style = document.createElement('style');
        style.id = 'hintAnimation';
        style.textContent = `
            @keyframes hint {
                0%, 100% { box-shadow: 0 0 0 rgba(255, 215, 0, 0); }
                50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            }
        `;
        document.head.appendChild(style);
    }
}

// ÂØªÊâæÂèØËÉΩÁöÑÁßªÂä®
function findPossibleMoves() {
    const possibleMoves = [];
    
    for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
            // Ê£ÄÊü•Âè≥‰æß‰∫§Êç¢
            if (col < 7) {
                const temp = gameState.grid[row][col];
                gameState.grid[row][col] = gameState.grid[row][col + 1];
                gameState.grid[row][col + 1] = temp;
                
                if (hasMatchAtPosition(row, col) || hasMatchAtPosition(row, col + 1)) {
                    possibleMoves.push({
                        from: { row, col },
                        to: { row, col: col + 1 }
                    });
                }
                
                // ÊÅ¢Â§ç
                gameState.grid[row][col + 1] = gameState.grid[row][col];
                gameState.grid[row][col] = temp;
            }
            
            // Ê£ÄÊü•‰∏ãÊñπ‰∫§Êç¢
            if (row < 7) {
                const temp = gameState.grid[row][col];
                gameState.grid[row][col] = gameState.grid[row + 1][col];
                gameState.grid[row + 1][col] = temp;
                
                if (hasMatchAtPosition(row, col) || hasMatchAtPosition(row + 1, col)) {
                    possibleMoves.push({
                        from: { row, col },
                        to: { row: row + 1, col }
                    });
                }
                
                // ÊÅ¢Â§ç
                gameState.grid[row + 1][col] = gameState.grid[row][col];
                gameState.grid[row][col] = temp;
            }
        }
    }
    
    return possibleMoves;
}

// UIÊõ¥Êñ∞
function updateUI() {
    document.getElementById('currentLevel').textContent = gameState.currentLevel || 'ÁªÉ‰π†';
    document.getElementById('score').textContent = gameState.score.toLocaleString();
    document.getElementById('target').textContent = gameState.target === Infinity ? '‚àû' : gameState.target.toLocaleString();
    document.getElementById('moves').textContent = gameState.moves === Infinity ? '‚àû' : gameState.moves;
    
    updatePowerUpUI();
}

// Ê∂àÊÅØÊòæÁ§∫
function showMessage(message, duration = 3000) {
    // ÁßªÈô§Áé∞ÊúâÊ∂àÊÅØ
    const existingMessage = document.querySelector('.game-message');
    if (existingMessage) {
        existingMessage.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'game-message';
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem 2rem;
        border-radius: 25px;
        z-index: 1000;
        text-align: center;
        font-weight: bold;
        animation: messageSlide 0.5s ease-out;
        max-width: 90vw;
        word-wrap: break-word;
    `;
    
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    // Ê∑ªÂä†Ê∂àÊÅØÂä®ÁîªCSS
    if (!document.querySelector('#messageAnimation')) {
        const style = document.createElement('style');
        style.id = 'messageAnimation';
        style.textContent = `
            @keyframes messageSlide {
                from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, duration);
}

// ÁâπÊÆäÊó•ÊúüÊïàÊûú
function createBirthdayEffect() {
    const effect = document.getElementById('specialDateEffect');
    for (let i = 0; i < 50; i++) {
        const cake = document.createElement('div');
        cake.innerHTML = 'üéÇ';
        cake.style.cssText = `
            position: absolute;
            font-size: 2rem;
            left: ${Math.random() * 100}%;
            animation: birthdayFloat ${Math.random() * 3 + 4}s linear infinite;
            animation-delay: ${Math.random() * 5}s;
        `;
        effect.appendChild(cake);
    }
    
    if (!document.querySelector('#birthdayAnimation')) {
        const style = document.createElement('style');
        style.id = 'birthdayAnimation';
        style.textContent = `
            @keyframes birthdayFloat {
                0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
                10% { opacity: 1; }
                90% { opacity: 1; }
                100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
}

function createValentineEffect() {
    const effect = document.getElementById('specialDateEffect');
    const hearts = ['üíï', 'üíñ', 'üíó', 'üíù', 'üíò'];
    
    for (let i = 0; i < 30; i++) {
        const heart = document.createElement('div');
        heart.innerHTML = hearts[Math.floor(Math.random() * hearts.length)];
        heart.style.cssText = `
            position: absolute;
            font-size: 2rem;
            left: ${Math.random() * 100}%;
            animation: valentineFloat ${Math.random() * 4 + 5}s ease-in-out infinite;
            animation-delay: ${Math.random() * 6}s;
        `;
        effect.appendChild(heart);
    }
    
    if (!document.querySelector('#valentineAnimation')) {
        const style = document.createElement('style');
        style.id = 'valentineAnimation';
        style.textContent = `
            @keyframes valentineFloat {
                0%, 100% { transform: translateY(100vh) scale(0); opacity: 0; }
                10%, 90% { opacity: 1; }
                50% { transform: translateY(50vh) scale(1); }
            }
        `;
        document.head.appendChild(style);
    }
}

// Êï∞ÊçÆÂ≠òÂÇ®
function saveGameData() {
    const data = {
        achievements: Array.from(gameState.achievements),
        totalScore: gameState.totalScore,
        gamesPlayed: gameState.gamesPlayed,
        perfectGames: gameState.perfectGames,
        maxCombo: gameState.maxCombo,
        soundEnabled: gameState.soundEnabled
    };
    
    try {
        localStorage.setItem('ashleyAppleGameData', JSON.stringify(data));
    } catch (e) {
        console.warn('Êó†Ê≥ï‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆ:', e);
    }
}

function loadGameData() {
    try {
        const data = localStorage.getItem('ashleyAppleGameData');
        if (data) {
            const parsed = JSON.parse(data);
            gameState.achievements = new Set(parsed.achievements || []);
            gameState.totalScore = parsed.totalScore || 0;
            gameState.gamesPlayed = parsed.gamesPlayed || 0;
            gameState.perfectGames = parsed.perfectGames || 0;
            gameState.maxCombo = parsed.maxCombo || 0;
            gameState.soundEnabled = parsed.soundEnabled !== false;
        }
    } catch (e) {
        console.warn('Êó†Ê≥ïÂä†ËΩΩÊ∏∏ÊàèÊï∞ÊçÆ:', e);
    }
}

// ‰∫ã‰ª∂ÁõëÂê¨Âô®ËÆæÁΩÆ
function setupEventListeners() {
    // Èò≤Ê≠¢È°µÈù¢ÊªöÂä®
    document.addEventListener('touchmove', function(e) {
        e.preventDefault();
    }, { passive: false });
    
    // Èò≤Ê≠¢ÂèåÂáªÁº©Êîæ
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(e) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            e.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // ÈîÆÁõòÊîØÊåÅÔºàÂèØÈÄâÔºâ
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && gameState.isGameActive) {
            if (gameState.isPaused) {
                resumeGame();
            } else {
                pauseGame();
            }
        }
    });
    
    // ÂàùÂßãÂåñÈÅìÂÖ∑ÊåâÈíÆ
    initializePowerUps();
}

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÊ∏∏Êàè
document.addEventListener('DOMContentLoaded', function() {
    initializeGame();
});

// È°µÈù¢Á¶ªÂºÄÊó∂‰øùÂ≠òÊï∞ÊçÆ
window.addEventListener('beforeunload', function() {
    saveGameData();
});

// ÂÆöÊúü‰øùÂ≠òÊï∞ÊçÆ
setInterval(() => {
    if (gameState.isGameActive) {
        saveGameData();
    }
}, 30000); // ÊØè30Áßí‰øùÂ≠ò‰∏ÄÊ¨°

</script>
</body>
</html>
